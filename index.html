<!DOCTYPE html><html>
<head>
	<title>Chimpaint! Beta</title>
	<style>
		body {  max-width: 800px; margin: 20px auto; }
		.controls { margin: 10px 0; }
		.control-group { margin: 8px 0; display: flex; align-items: center; gap: 10px; }
		.control-group label { min-width: 180px; }
		button { padding: 8px 12px; margin: 4px; cursor: pointer; }
		#content { border: 2px solid #333; image-rendering: pixelated; }
		.section { margin: 20px 0; padding: 15px; background: #f5f5f5; border:1px solid black;border-radius: 4px; }
		.playback-controls { display: flex; gap: 10px; align-items: center; }
		#theVoices {
			visibility:hidden;
		}
	</style>
</head>
<body>
	<script src="latent_shapes.js"></script>
	<script src="general_vae_model.js"></script>
    <script src="https://unpkg.com/brain.js"></script>
	<canvas id="theVoices" width="16" height="16"></canvas>
	<canvas id="content" width="16" height="16" style="width:256px;height:256px;"></canvas>
	Anti Alias <input type="checkbox" id="antialias">
	<div class="section">
		<h3>Motion</h3>
		<div class="controls">
			<div class="control-group">
				<label>Intensity: <span id="shiftVal">0.3</span></label>
				<input type="range" min="0.05" max="0.6" step="0.05" id="shift" value="0.3">
			</div>
			<div class="control-group">
				<label>Smoothness: <span id="momentumVal">0.85</span></label>
				<input type="range" min="0.5" max="0.98" step="0.01" id="momentum" value="0.85">
			</div>
			<div class="control-group">
				<label>Stability: <span id="structureVal">0.3</span></label>
				<input type="range" min="0.0" max="1.0" step="0.05" id="structure" value="0.3">
			</div>
		</div>
	</div>

	<div class="section">
		<h3>Playback</h3>
		<div class="playback-controls">
			<button id="playMotion">‚ñ∂ </button>
			<button id="stopMotion">‚è∏ </button>
			<button id="seedshift">‚Üí Step</button>
			<label>FPS: <span id="fpsVal">24</span></label>
			<input type="range" min="6" max="60" step="6" id="fps" value="24">
		</div>
	</div>

	<div class="section">
		<h3>Modes</h3>
		<button id="modeSmooth">Smooth</button>
		<button id="modeOrganic">Organic</button>
		<button id="modeDirected">Directed</button>
		<button id="modeUnfiltered">Unfiltered</button>
		<div style="margin-top: 10px;">
			<small>Current Mode: <strong id="currentMode">Smooth</strong></small>
		</div>
	</div>

	<div class="section">
		<h3>Seeds</h3>
		<button id="seedran">üé≤ </button>
		<button id="seedtroll">Troll</button>
		<button id="seedbnrj">Jon Mud BNRJ</button>
		<button id="seedbia">Bia 1</button>
		<button id="seedmsn">MSN 1</button>
		<button id="seedsmiley">Smiley Icon</button>
		<button id="seedface1">Face 1</button>
	</div>

	<script defer>
		function $(a){return document.getElementById(a);}
		function arrayify(netOut){
			let netOuts = Object.keys(netOut);
			let result = [];
			for(let i=0;i<netOuts.length;i++){
				result.push(netOut[netOuts[i]]);
			}
			return result;
		}

		let canvas = $('content');
		let ctx = canvas.getContext('2d');
		
		let encoder = new brain.NeuralNetwork({
			hiddenLayers: [Math.floor(768 / 2), 16],
			activation: 'tanh',
			learningRate:0.005
		});
		let decoder = new brain.NeuralNetwork({
			hiddenLayers: [16, Math.floor(768 / 2)],
			activation: 'sigmoid',
			learningRate:0.03
		});


		let currentLatent = [];
		let velocity = new Array(16).fill(0);
		let targetLatent = null;
		let frameChange = 0.3;
		let momentum = 0.85;
		let structureStability = 0.3; 
		let motionMode = 'smooth';
		let isPlaying = false;
		let animationId = null;
		let fps = 24;
		let noiseOffset = 0;


		let dimWeights = [
			0.2, 0.2, 0.3, 0.3,//structure and composition
			0.5, 0.5, 0.6, 0.6,//mid level features
			0.8, 0.8, 0.9, 0.9,//fine details
			1.0, 1.0, 1.0, 1.0//texture/noise 
		];
		
		encoder.fromJSON(generalNet["encoder"]);
		decoder.fromJSON(generalNet["decoder"]);

		function latentify(imgSrc){
			let canvas2 = $('theVoices');
			let ctx2 = canvas2.getContext('2d');
			if(typeof imgSrc == 'string'){
				let imgData = new Image();
				imgData.src = imgSrc;
				imgData.onload = () => {
					ctx2.drawImage(imgData,0,0,canvas2.width,canvas2.height);
					ctx
				}
			}
		}
		//shitty
		function noise1D(x) {
			let X = Math.floor(x) & 255;
			x -= Math.floor(x);
			let u = x * x * (3.0 - 2.0 * x);
			let a = Math.sin(X * 12.9898 + 78.233) * 43758.5453;
			let b = Math.sin((X + 1) * 12.9898 + 78.233) * 43758.5453;
			a = a - Math.floor(a);
			b = b - Math.floor(b);
			return a * (1.0 - u) + b * u;
		}

		function drawLatent(latentSpace){
		    currentLatent = latentSpace;
			let decoded = arrayify(decoder.run(latentSpace));
			let newImg = ctx.getImageData(0,0,canvas.width,canvas.height);
			for(let i=0;i<decoded.length;i+=4){
				decoded.splice(i+3,0,1);
			}
			for(let i=0;i<newImg.data.length;i++){
				newImg.data[i] = decoded[i]*255;
			}
			ctx.putImageData(newImg,0,0);
		}

		function stepMotion() {
			noiseOffset += 0.02;

			for(let i = 0; i < currentLatent.length; i++){
				let acceleration = 0;
				let dimWeight = dimWeights[i];
				let stabilityFactor = i < 4 ? structureStability : 0;

				switch(motionMode) {
					case 'smooth':
						//aids
						acceleration = (Math.random() - 0.5) * frameChange * 0.15 * dimWeight;
						break;

					case 'organic':
						//perlin
						let noiseVal = noise1D(i * 0.5 + noiseOffset) * 2 - 1;
						acceleration = noiseVal * frameChange * 0.2 * dimWeight;
						break;

					case 'directed':
						if(targetLatent) {
							let diff = targetLatent[i] - currentLatent[i];
							acceleration = diff * 0.08 * dimWeight;
							//mcseasoning or however
							acceleration += (Math.random() - 0.5) * frameChange * 0.05;
						} else {
							acceleration = (Math.random() - 0.5) * frameChange * 0.1 * dimWeight;
						}
						break;

					case 'unfiltered':
						acceleration = (Math.random() - 0.5) * frameChange * 0.4 * dimWeight;
						velocity[i] *= 0.6; 
						break;
				}

				acceleration *= (1.0 - stabilityFactor);

				let currentMomentum = motionMode === 'unfiltered' ? 0.6 : momentum;
				velocity[i] = velocity[i] * currentMomentum + acceleration;
				
				let maxVel = motionMode === 'unfiltered' ? 0.8 : 0.4;
				velocity[i] = Math.max(-maxVel, Math.min(maxVel, velocity[i]));
				
				currentLatent[i] += velocity[i];
				
				currentLatent[i] = Math.max(-3.5, Math.min(3.5, currentLatent[i]));
			}

			drawLatent(currentLatent);
		}

		function playAnimation() {
			if(!isPlaying) return;
			stepMotion();
			animationId = setTimeout(() => requestAnimationFrame(playAnimation), 1000/fps);
		}
		let aliased = false;
		$('antialias').onclick = () => {
			aliased = !aliased
			if(aliased)$('content').style.imageRendering = 'initial';
			else $('content').style.imageRendering = 'pixelated';
		}
		$('shift').oninput = () => {
			frameChange = parseFloat($('shift').value);
			$('shiftVal').textContent = frameChange.toFixed(2);
		}

		$('momentum').oninput = () => {
			momentum = parseFloat($('momentum').value);
			$('momentumVal').textContent = momentum.toFixed(2);
		}

		$('structure').oninput = () => {
			structureStability = parseFloat($('structure').value);
			$('structureVal').textContent = structureStability.toFixed(2);
		}

		$('fps').oninput = () => {
			fps = parseInt($('fps').value);
			$('fpsVal').textContent = fps;
		}

		$('seedshift').onclick = () => {
			stepMotion();
		}

		$('playMotion').onclick = () => {
			isPlaying = true;
			playAnimation();
		}

		$('stopMotion').onclick = () => {
			isPlaying = false;
			if(animationId) clearTimeout(animationId);
		}

		$('seedran').onclick = () => {
			let latent = [];
			for(let i=0;i<16;i++){latent.push((Math.random() - 0.5) * 2)}
			currentLatent = latent;
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedtroll').onclick=()=>{
			currentLatent = [...Latents["troll_normal"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}
		$('seedface1').onclick=()=>{
			currentLatent = [...Latents["face_1"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedbnrj').onclick=()=>{
			currentLatent = [...Latents["jon_mud_brand_new_ripped_jeans"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}
$('seedbia').onclick=()=>{
		currentLatent = [...Latents["bia_1"]];
		velocity.fill(0);
		targetLatent = null;
		drawLatent(currentLatent);
	}

	$('seedmsn').onclick=()=>{
		currentLatent = [...Latents["msn_1"]];
		velocity.fill(0);
		targetLatent = null;
		drawLatent(currentLatent);
	}

	$('seedsmiley').onclick=()=>{
		currentLatent = [...Latents["smiley_icon"]];
		velocity.fill(0);
		targetLatent = null;
		drawLatent(currentLatent);
	}

		$('modeSmooth').onclick = () => {
			motionMode = 'smooth';
			$('currentMode').textContent = 'Smooth';
		}

		$('modeOrganic').onclick = () => {
			motionMode = 'organic';
			$('currentMode').textContent = 'Organic';
		}

		$('modeDirected').onclick = () => {
			motionMode = 'directed';

			targetLatent = [];
			for(let i=0;i<16;i++){targetLatent.push((Math.random() - 0.5) * 2.5)}
			$('currentMode').textContent = 'Directed';
		}

		$('modeUnfiltered').onclick = () => {
			motionMode = 'unfiltered';
			$('currentMode').textContent = 'Unfiltered';
		}


		let latent = [];
		for(let i=0;i<16;i++){latent.push((Math.random() - 0.5) * 2)}
		drawLatent(latent);
	</script>
</body>
</html>
