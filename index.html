<!DOCTYPE html><html>
<head>
	<title>Chimpaint! Beta</title>
	<style>
		html {
   			width: 100%;
    		height: 100%;
    		padding: 0;
    		margin: 0;
		}
		body {
    width: 100%;
    height: 100%;
    background: #b5b5b5;
    color: white;
    text-shadow: 2px 2px 2px rgba(0,0,0,0.4);
    background: linear-gradient(0deg, rgba(181, 181, 181, 1) 0%, rgba(0, 0, 0, 1) 100%);
    background-size: 150% 120%;
    background-attachment: fixed;
    background-repeat: no-repeat;
}
		.controls { margin: 10px 0; }
		.control-group { margin: 8px 0; display: flex; align-items: center; gap: 10px; }
		.control-group label { min-width: 180px; }
		button { padding: 8px 12px; margin: 4px; cursor: pointer; }
		#content { border: 2px solid #333; image-rendering: pixelated; }
		.section {
			margin: 20px 0; padding: 15px; border:1px solid black;border-radius: 4px; 
    		background: linear-gradient(0deg,rgba(171, 205, 217, 1) 0%, rgba(143, 159, 161, 1) 13%, rgba(109, 130, 130, 1) 23%, rgba(93, 108, 115, 1) 34%, rgba(157, 172, 181, 1) 84%, rgba(230, 237, 237, 1) 100%);
    		background-size: cover;
    		background-repeat: no-repeat;
		}
		.playback-controls { display: flex; gap: 10px; align-items: center; }
		#theVoices {
			visibility:hidden;
		}
		.menu {
			display:flex;
			gap:10px;
			width:100%;
			height:200px;
			padding:5px;
		}
		.tuning-controls { display: flex; flex-direction: column; gap: 10px; }
		.tuning-row { display: flex; gap: 10px; align-items: center; }
		#tuneImageUrl { flex: 1; padding: 8px; }
		#encodeImageUrl { flex: 1; padding: 8px; }
		#tuneIterations { width: 100px; padding: 8px; }
		#tuneButton { padding: 8px 12px; }
		#encodeButton { padding: 8px 12px; }
		#tuneButton:disabled { opacity: 0.5; cursor: not-allowed; }
		#encodeButton:disabled { opacity: 0.5; cursor: not-allowed; }
	</style>
</head>
<body>
	<script src="latent_shapes.js"></script>
	<script src="monky_model.js"></script>
    <script src="https://unpkg.com/brain.js"></script>
	<div class="menu">
		<img src="./src/logo.png" width="200" height="auto">
	</div>
	<canvas id="theVoices" width="16" height="16"></canvas>
	<canvas id="content" width="16" height="16" style="width:256px;height:256px;"></canvas>
	Anti Alias <input type="checkbox" id="antialias">
	<br>
	<button id="scene_start">üéûÔ∏è</button>
	<button id="scene_end">üü•</button>
	<button id="scene_trash">üóëÔ∏è</button>
	<br>
	<p id="framecount"></p>
	<div class="section">
		<h3>Motion</h3>
		<div class="controls">
			<div class="control-group">
				<label>Intensity: <span id="shiftVal">0.3</span></label>
				<input type="range" min="0.05" max="0.25" step="0.05" id="shift" value="0.3">
			</div>
			<div class="control-group">
				<label>Smoothness: <span id="momentumVal">0.85</span></label>
				<input type="range" min="0.5" max="0.98" step="0.01" id="momentum" value="0.85">
			</div>
			<div class="control-group">
				<label>Stability: <span id="structureVal">0.3</span></label>
				<input type="range" min="0.0" max="1.0" step="0.05" id="structure" value="0.3">
			</div>
		</div>
	</div>

	<div class="section">
		<h3>Playback</h3>
		<div class="playback-controls">
			<button id="playMotion">‚ñ∂ </button>
			<button id="stopMotion">‚è∏ </button>
			<button id="seedshift">‚Üí Step</button>
			||
			<button id="scene_play">üéûÔ∏è</button>
			<label>FPS: <span id="fpsVal">24</span></label>
			<input type="range" min="6" max="60" step="6" id="fps" value="24">
		</div>
	</div>

	
	<div class="section">
		<h3>Modes</h3>
		<button id="modeSmooth">Smooth</button>
		<button id="modeOrganic">Organic</button>
		<button id="modeDirected">Directed</button>
		<button id="modeUnfiltered">Unfiltered</button>
		<div style="margin-top: 10px;">
			<small>Current Mode: <strong id="currentMode">Smooth</strong></small>
		</div>
	</div>
	
	<div class="section" style="display:none;">
		<h3>Seeds</h3>
		<button id="seedran">üé≤ </button>
		<button id="seedtroll">Troll</button>
		<button id="seedbnrj">Jon Mud BNRJ</button>
		<button id="seedbia">Bia 1</button>
		<button id="seedmsn">MSN 1</button>
		<button id="seedsmiley">Smiley Icon</button>
		<button id="seedface1">Face 1</button>
	</div>
	
	<div class="section">
		<h3>VAE Operations</h3>
		<div class="tuning-controls">
			<div class="tuning-row">
				<label>Image URL (Display):</label>
				<input type="text" id="encodeImageUrl" placeholder="Enter image URL to encode and display">
				<button id="encodeButton">Encode & Display</button>
			</div>
			<small>‚ö†Ô∏è Encodes image through VAE and displays reconstruction on canvas. Its recommended you train the model on the image first.</small>
			<hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.2);">
			<div class="tuning-row">
				<label>Image URL (Train):</label>
				<input type="text" id="tuneImageUrl" placeholder="Enter image URL to train model">
			</div>
			<div class="tuning-row">
				<label>Iterations:</label>
				<input type="number" id="tuneIterations" value="100" min="10" max="10000" step="10">
				<button id="tuneButton">Train Model</button>
			</div>
			<small>‚ö†Ô∏è Training will freeze the UI. Open devtools console (F12) to see progress.</small>
		</div>
	</div>

	<script defer>
		function $(a){return document.getElementById(a);}
		function arrayify(netOut){
			let netOuts = Object.keys(netOut);
			let result = [];
			for(let i=0;i<netOuts.length;i++){
				result.push(netOut[netOuts[i]]);
			}
			return result;
		}
        let frames = [];
		let canvas = $('content');
		let ctx = canvas.getContext('2d');
		
		let encoder = new brain.NeuralNetwork({
			hiddenLayers: [Math.floor(768 / 2), 16],
			activation: 'tanh',
			learningRate:0.005
		});
		let decoder = new brain.NeuralNetwork({
			hiddenLayers: [16, Math.floor(768 / 2)],
			activation: 'sigmoid',
			learningRate:0.03
		});


		let currentLatent = [];
		let velocity = new Array(16).fill(0);
		let targetLatent = null;
		let frameChange = 0.3;
		let momentum = 0.85;
		let structureStability = 0.3; 
		let motionMode = 'smooth';
		let isPlaying = false;
		let animationId = null;
		let fps = 24;
		let noiseOffset = 0;


		let dimWeights = [
			0.2, 0.2, 0.3, 0.2,
			0.5, 0.5, 0.6, 0.6,
			0.5, 0.5, 0.5, 0.5,
			0.7, 0.7, 0.7, 0.7
		];
		
		encoder.fromJSON(generalNet["encoder"]);
		decoder.fromJSON(generalNet["decoder"]);

		function latentify(imgSrc){
			let canvas2 = $('theVoices');
			let ctx2 = canvas2.getContext('2d');
			if(typeof imgSrc == 'string'){
				let imgData = new Image();
				imgData.src = imgSrc;
				imgData.onload = () => {
					ctx2.drawImage(imgData,0,0,canvas2.width,canvas2.height);
					ctx
				}
			}
		}

		function noise1D(x) {
			let X = Math.floor(x) & 255;
			x -= Math.floor(x);
			let u = x * x * (3.0 - 2.0 * x);
			let a = Math.sin(X * 12.9898 + 78.233) * 43758.5453;
			let b = Math.sin((X + 1) * 12.9898 + 78.233) * 43758.5453;
			a = a - Math.floor(a);
			b = b - Math.floor(b);
			return a * (1.0 - u) + b * u;
		}

		function drawLatent(latentSpace){
		    currentLatent = latentSpace;
			let decoded = arrayify(decoder.run(latentSpace));
			let newImg = ctx.getImageData(0,0,canvas.width,canvas.height);
			for(let i=0;i<decoded.length;i+=4){
				decoded.splice(i+3,0,1);
			}
			for(let i=0;i<newImg.data.length;i++){
				newImg.data[i] = decoded[i]*255;
			}
			ctx.putImageData(newImg,0,0);
		}

		function stepMotion() {
			noiseOffset += 0.02;

			for(let i = 0; i < currentLatent.length; i++){
				let acceleration = 0;
				let dimWeight = dimWeights[i];
				let stabilityFactor = i < 4 ? structureStability : 0;

				switch(motionMode) {
					case 'smooth':
						acceleration = (Math.random() - 0.5) * frameChange * 0.15 * dimWeight;
						break;

					case 'organic':
						let noiseVal = noise1D(i * 0.5 + noiseOffset) * 2 - 1;
						acceleration = noiseVal * frameChange * 0.2 * dimWeight;
						break;

					case 'directed':
						if(targetLatent) {
							let diff = targetLatent[i] - currentLatent[i];
							acceleration = diff * 0.08 * dimWeight;
							acceleration += (Math.random() - 0.5) * frameChange * 0.05;
						} else {
							acceleration = (Math.random() - 0.5) * frameChange * 0.1 * dimWeight;
						}
						break;

					case 'unfiltered':
						acceleration = (Math.random() - 0.5) * frameChange * 0.4 * dimWeight;
						velocity[i] *= 0.6; 
						break;
				}

				acceleration *= (1.0 - stabilityFactor);

				let currentMomentum = motionMode === 'unfiltered' ? 0.6 : momentum;
				velocity[i] = velocity[i] * currentMomentum + acceleration;
				
				let maxVel = motionMode === 'unfiltered' ? 0.8 : 0.4;
				velocity[i] = Math.max(-maxVel, Math.min(maxVel, velocity[i]));
				
				currentLatent[i] += velocity[i];
				
				currentLatent[i] = Math.max(-3.5, Math.min(3.5, currentLatent[i]));
			}

			drawLatent(currentLatent);
		}
		let recordingVideo = false;
		function playAnimation() {
			if(!isPlaying) return;
			stepMotion();
			animationId = setTimeout(() => {if(recordingVideo==true){frames.push(ctx.getImageData(0,0,canvas.width,canvas.height).data)}requestAnimationFrame(playAnimation)}, 1000/fps);
		}
		let aliased = false;
		
		function play(){
			isPlaying = true;
			playAnimation();
		}
		function stop(){
			isPlaying = false;
			if(animationId) clearTimeout(animationId);
		}
		function recordScene(){
			recordingVideo=true;
		}
		function stopScene() {
			recordingVideo=false;
			stop();
		}
		function trashScene(){
			frames = [];
		}
		function playScene(sceneQueue = 1){
			if(frames.length === 0)return;
			let frame = 0;

			let draw = () => {
				let newData = ctx.getImageData(0, 0, canvas.width, canvas.height); 
				for(let i=0;i<newData.data.length;i++){
					newData.data[i] = frames[frame][i];
				}
				ctx.putImageData(newData,0,0);
				if(frame < frames.length - 1) {
					frame++;
					setTimeout(draw, 1000 / fps); 
				}
			}
			draw();
		}

		async function encodeAndDisplay() {
			let imageUrl = $('encodeImageUrl').value.trim();

			if (!imageUrl) {
				alert('Please enter an image URL');
				return;
			}

			$('encodeButton').disabled = true;
			$('encodeButton').textContent = 'Encoding...';

			try {
				let img = new Image();
				img.crossOrigin = 'anonymous';
				
				await new Promise((resolve, reject) => {
					img.onload = resolve;
					img.onerror = () => reject(new Error('Failed to load image'));
					img.src = imageUrl;
				});

				let tempCanvas = $('theVoices');
				let tempCtx = tempCanvas.getContext('2d');
				tempCtx.drawImage(img, 0, 0, 16, 16);
				
				let imageData = tempCtx.getImageData(0, 0, 16, 16);
				let pixels = [];
				
				for (let i = 0; i < imageData.data.length; i += 4) {
					pixels.push(imageData.data[i] / 255);
					pixels.push(imageData.data[i + 1] / 255);
					pixels.push(imageData.data[i + 2] / 255);
				}

				let latent = arrayify(encoder.run(pixels));

				currentLatent = latent;
				velocity.fill(0);
				targetLatent = null;
				drawLatent(currentLatent);

			} catch (error) {
				console.error('Encoding error:', error);
				alert('Error encoding image: ' + error.message);
			} finally {
				$('encodeButton').disabled = false;
				$('encodeButton').textContent = 'Encode & Display';
			}
		}
		
		async function tuneModel() {
			let imageUrl = $('tuneImageUrl').value.trim();
			let iterations = parseInt($('tuneIterations').value);

			if (!imageUrl) {
				alert('Please enter an image URL');
				return;
			}

			if (iterations < 10 || iterations > 10000) {
				alert('Iterations must be between 10 and 10000');
				return;
			}

			alert('Training started, open devtools console (F12) to see progress. The UI will freeze during training.');

			$('tuneButton').disabled = true;
			$('tuneButton').textContent = 'Training...';

			try {
				let img = new Image();
				img.crossOrigin = 'anonymous';
				
				await new Promise((resolve, reject) => {
					img.onload = resolve;
					img.onerror = () => reject(new Error('Failed to load image'));
					img.src = imageUrl;
				});

				let tempCanvas = $('theVoices');
				let tempCtx = tempCanvas.getContext('2d');
				tempCtx.drawImage(img, 0, 0, 16, 16);
				
				let imageData = tempCtx.getImageData(0, 0, 16, 16);
				let pixels = [];
				
				for (let i = 0; i < imageData.data.length; i += 4) {
					pixels.push(imageData.data[i] / 255);
					pixels.push(imageData.data[i + 1] / 255);
					pixels.push(imageData.data[i + 2] / 255);
				}

				console.log('Image loaded, pixel data length:', pixels.length);
				console.log('Starting training with', iterations, 'iterations');

				let encoderIterations = Math.floor(iterations * 0.6);
				let decoderIterations = iterations - encoderIterations;

				let encoderTraining = [{ input: pixels, output: currentLatent.length ? currentLatent : new Array(16).fill(0) }];
				
				console.log('Training encoder for', encoderIterations, 'iterations...');
				encoder.train(encoderTraining, {
					iterations: encoderIterations,
					errorThresh: 0.000001,
					log: true,
					logPeriod: 10,
					errorFunction: (target, output) => {
						var reconstructionLoss = target.reduce((sum, val, i) => 
							sum + Math.pow(val - output[i], 2), 0) / target.length;
						
						var mu = output.slice(0, 2);
						var klDivergence = -0.5 * mu.reduce((sum, m) => 
							sum + (1 + Math.log(0.01) - m * m - 0.01), 0);
						
						var beta = 0.1;
						return reconstructionLoss + beta * klDivergence;
					}
				});

				
				let latent = arrayify(encoder.run(pixels));
				console.log('Latent representation:', latent);

				let decoderTraining = [{ input: latent, output: pixels }];

				console.log('Training decoder for', decoderIterations, 'iterations...');
				decoder.train(decoderTraining, {
					iterations: decoderIterations,
					errorThresh: 0.00001,
					log: true,
					logPeriod: 10
				});

				console.log('Training complete!');

				currentLatent = latent;
				velocity.fill(0);
				drawLatent(currentLatent);

				alert('Training complete! Model has been tuned on your image.');

			} catch (error) {
				console.error('Training error:', error);
				alert('Error during training: ' + error.message);
			} finally {
				$('tuneButton').disabled = false;
				$('tuneButton').textContent = 'Train Model';
			}
		}

		setInterval(() => {
		$('framecount').innerHTML='Saved rames: '+frames.length;
		},1000);
		$('scene_start').onclick = () => {recordScene();};
		$('scene_end').onclick = () => {stopScene();};
		$('scene_play').onclick = () => {playScene();};
		$('scene_trash').onclick = () => {trashScene();};
		$('tuneButton').onclick = tuneModel;
		$('encodeButton').onclick = encodeAndDisplay;

		$('antialias').onclick = () => {
			aliased = !aliased
			if(aliased)$('content').style.imageRendering = 'initial';
			else $('content').style.imageRendering = 'pixelated';
		}
		$('shift').oninput = () => {
			frameChange = parseFloat($('shift').value);
			$('shiftVal').textContent = frameChange.toFixed(2);
		}

		$('momentum').oninput = () => {
			momentum = parseFloat($('momentum').value);
			$('momentumVal').textContent = momentum.toFixed(2);
		}

		$('structure').oninput = () => {
			structureStability = parseFloat($('structure').value);
			$('structureVal').textContent = structureStability.toFixed(2);
		}

		$('fps').oninput = () => {
			fps = parseInt($('fps').value);
			$('fpsVal').textContent = fps;
		}

		$('seedshift').onclick = () => {
			stepMotion();
		}
		
		$('playMotion').onclick = () => {play();};

		$('stopMotion').onclick = () => {stop();};
		$('seedran').onclick = () => {
			let latent = [];
			for(let i=0;i<16;i++){latent.push((Math.random() - 0.5) * 2)}
			currentLatent = latent;
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedtroll').onclick=()=>{
			currentLatent = [...Latents["troll_normal"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}
		$('seedface1').onclick=()=>{
			currentLatent = [...Latents["face_1"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedbnrj').onclick=()=>{
			currentLatent = [...Latents["jon_mud_brand_new_ripped_jeans"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}
		$('seedbia').onclick=()=>{
			currentLatent = [...Latents["bia_1"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedmsn').onclick=()=>{
			currentLatent = [...Latents["msn_1"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('seedsmiley').onclick=()=>{
			currentLatent = [...Latents["smiley_icon"]];
			velocity.fill(0);
			targetLatent = null;
			drawLatent(currentLatent);
		}

		$('modeSmooth').onclick = () => {
			motionMode = 'smooth';
			$('currentMode').textContent = 'Smooth';
		}

		$('modeOrganic').onclick = () => {
			motionMode = 'organic';
			$('currentMode').textContent = 'Organic';
		}

		$('modeDirected').onclick = () => {
			motionMode = 'directed';

			targetLatent = [];
			for(let i=0;i<16;i++){targetLatent.push((Math.random() - 0.5) * 2.5)}
			$('currentMode').textContent = 'Directed';
		}

		$('modeUnfiltered').onclick = () => {
			motionMode = 'unfiltered';
			$('currentMode').textContent = 'Unfiltered';
		}


		let latent = [];
		for(let i=0;i<16;i++){latent.push((Math.random() - 0.5) * 2)}
		drawLatent(latent);
	</script>
</body>
</html>